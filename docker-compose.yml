# =============================================================================
# Docker Compose Configuration
# Development and local testing environment
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Auth System Service
  # ---------------------------------------------------------------------------
  elano-auth-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: elano/auth-system-service:latest
    container_name: elano-auth-system
    restart: unless-stopped
    
    # Port mapping
    ports:
      - "5000:5000"
    
    # Environment variables
    environment:
      NODE_ENV: production
      PORT: 5000
      HOST: 0.0.0.0
      
      # MongoDB connection (MONGO_URI not MONGODB_URI)
      MONGO_URI: ${MONGO_URI}
      
      # JWT secret
      JWT_SECRET: ${JWT_SECRET}
      
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL:-http://localhost:5000/api/auth/google/callback}
      
      # Cloudinary (file uploads)
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      
      # Mailgun configuration
      MAILGUN_API_KEY: ${MAILGUN_API_KEY}
      MAILGUN_DOMAIN: ${MAILGUN_DOMAIN}
      
      # Resend API configuration
      RESEND_API_KEY: ${RESEND_API_KEY}
      FROM_EMAIL: ${FROM_EMAIL}
      QUOUTE_FROM_EMAIL: ${QUOUTE_FROM_EMAIL}
      
      # Rate limiting
      TRUSTED_IPS: ${TRUSTED_IPS:-127.0.0.1,10.0.0.1}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}
      SENSITIVE_OP_WINDOW_MS: ${SENSITIVE_OP_WINDOW_MS:-3600000}
      SENSITIVE_OP_MAX_REQUESTS: ${SENSITIVE_OP_MAX_REQUESTS:-50}
      
      # Paystack configuration
      PAYSTACK_SECRET_KEY: ${PAYSTACK_SECRET_KEY}
      PAYSTACK_PUBLIC_KEY: ${PAYSTACK_PUBLIC_KEY}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      WEBHOOK_URL: ${WEBHOOK_URL}
      
      # Default free plan ID
      DEFAULT_FREE_PLAN_ID: ${DEFAULT_FREE_PLAN_ID}
      
      # OpenWeather API
      OPENWEATHER_API_KEY: ${OPENWEATHER_API_KEY}
      
      # Gemini AI API
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    
    # Volume mounts
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./temp:/app/temp
    
    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Networks - Connect to the same network as MongoDB
    networks:
      - organization_registration_elano-network

# =============================================================================
# Networks
# =============================================================================
networks:
  # Connect to existing organization registration network where MongoDB lives
  organization_registration_elano-network:
    external: true